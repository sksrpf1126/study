# **_네트워크 통신과정 (ARP, Routing)_**

- ## **_ARP (Address Resolution Protocol)_**

  - **_"ARP"_** 는 IP주소에 매칭이 되는 MAC주소를 찾는 것

      <p align ="center"><img src="https://user-images.githubusercontent.com/62879192/185731882-572e9ad6-97e5-4c2c-8bea-7e2402193319.png"></p>

  - 위는 ARP 패킷 구조이며, MAP과 IP주소에만 집중해서 분석해보면

    1. **_출발지 MAC 주소_** (ARP 요청을 날린 인터페이스), **_목적지 MAC 주소_** (아직 모르는 상태이기에 브로드캐스트 주소로 채움)  
       -> 브로드캐스트 주소는 FF:FF:FF:FF:FF:FF로 L2 스위치에게 자신 이외의 스위치와 연결된 모든 포트에게 요청하는 주소이다.
    2. **_송신지 MAC 주소_** (ARP 요청 날린 인터페이스), **_송신지 IP주소_** (ARP 요청 날린 인터페이스)

    3. **_수신지 MAC주소_** (모름), **_수신지 IP주소_** (찾고자 하는 MAC주소를 가진 인터페이스의 IP주소)

  - https://run-it.tistory.com/16?category=665122 <- ※ARP 통신과정을 그림으로 자세히 설명되어 있음※

  - 위 그림을 요약한 내용으로는
    1. 통신하고자 하는 IP와 매칭이 되는 MAC 주소를 ARP 테이블에서 찾아본다.
    2. 테이블에 존재하지 않을 경우에 MAC주소를 알아내기 위해 ARP 패킷을 준비.
    3. 목적지 MAC 주소를 브로드캐스트 주소로 하여, 자신을 제외한 같은 서브넷(네트워크 대역)에 위치한 인터페이스들에게 전부 ARP request를 날린다.
    4. 인터페이스들은 각자 ARP 패킷에서 자신이 대상인지를 IP를 통해 비교하고, 자신이 아니면 패킷은 버려진다.
    5. 수신지IP가 일치한 인터페이스는 자신의 MAC주소를 요청한 인터페이스에게 알려주기 위하여 ARP 패킷을 준비하며, 목적지의 MAC주소는 이미 알고 있기에 해당 주소로 채움
    6. 요청한 인터페이스에게 정상적으로 ARP 패킷 전달이 되고, 해당 인터페이스는 ARP 테이블에 기록해 둔다.

  </br>

---

- ## **_Routing_**

  - **_"라우팅"_** 이란 목적지 IP를 찾아가기 위한 과정을 의미하며, 현실에서 목적지까지 가는 길을 잘 모를때 네비 또는 길찾기를 통하여 최적의 경로를 안내 받아 그 경로를 따라 가듯이, 라우팅 또한 라우팅 테이블에 있는 기록을 보고 목적지 IP까지 찾아가게 된다.  
    **_라우팅 테이블_** 은 네트워크 장비들마다 존재하며, 네트워크 장비(대표적으로 라우터)들 간에 서로의 테이블을 공유하여 학습한다는 등 여러 방식으로 스스로 학습하는 것, 그리고 사용자(관리자)가 직접 라우팅 테이블을 작성하는 것으로 작성이 된다.

    </br>

      <p align ="center"><img src="https://user-images.githubusercontent.com/62879192/185731886-3e81e18b-d369-44a7-a8a7-08f0599f1a13.jpg"></p>

  - 위 이미지가 라우팅 테이블이다.
  - 1.1.1.0, 2.2.2.0, 3.3.3.0, 5.5.5.0 의 대역대는 Gateway가 0.0.0.0 인 것을 통해서 자신과 직접 연결되어 있다는 것을 알 수 있으며, 4.4.4.0 대역대는 Gateway가 3.3.3.2 인것을 보아 자신과 연결된 것이 아닌 다른 인터페이스 장비로 나가야 하는 것을 알 수 있다.
  - 기록이 되지 않은 나머지 대역대들은 default Gateway로 나가는데 맨 아래의 Destination 이 0.0.0.0 이고 넷마스크가 0.0.0.0에 해당하는 게이트웨이가 기본 게이트웨이(5.5.5.2에 해당)

    </br>

      <p align ="center"><img src="https://user-images.githubusercontent.com/62879192/185731890-6793690e-4c79-4252-8466-d7773861578b.jpg"></p>

  - 1.1.1.0 대역은 Eth1로, 2.2.2.0 대역대는 Eth2로, 4.4.4.0 대역대는 Eth3을 타고 3.3.3.2 GateWay로 가는것
  - 결국 Gateway는 데이터가 목적지로 가기 위해 지나가야하는 연결 된 장비의 주소를 의미

  - **_인터넷에서는 이러한 수많은 경로(라우터)들 중 최적의 경로를 통해 목적지IP까지 도달하게 되는 것_**

</br>

---

- ## **_네트워크 통신 과정_**

    <p align ="center"><img src="https://user-images.githubusercontent.com/62879192/185732485-97ec0498-574a-4e00-9692-b1918ac17e84.png"></p>

  - https://run-it.tistory.com/18?category=665122 에서의 설명을 이해하고 나만의 방식으로 설명

  AA 와 DD간의 네트워크 통신 과정 설명

  - 구조는 L3 #1, L3 #2는 라우터이며, L3 #1 아래에는 1.1.1.0 네트워크 대역과 2.2.2.0 네트워크 대역으로 나뉨  
    1.1.1.0 대역대에는 스위치를 통하여 PC들을 분배하였으며, 각각 1.1.1.2, 1.1.1.3 IP를 지님(AA, BB이며 Default Gateway -> 1.1.1.1)  
    CC는 L3 #1 아래의 2.2.2.0 대역대에 존재하는 PC로 2.2.2.2 IP를 지님(2.2.2.1은 Default Gateway)  
    L3 #2는 4.4.4.0 대역대를 관리하며, 4.4.4.2의 IP는 DD에게 할당(4.4.4.1은 Default Gateway)

  </br>

  1. AA는 4.4.4.2라는 IP와 통신을 하고자하지만, 해당 IP가 같은 네트워크인지, 다른 네트워크인지 모르기 때문에 자신의 Routing Table을 확인(Routing)
  2. Routing Table에서 경우 2가지로 나뉨  
     2-1) Routing Table에 4.4.4.2로 가기 위한 경로(게이트웨이)를 알고 있는가  
     2-2) Routing Table에 4.4.4.2로 가기 위한 경로(게이트웨이)를 모르는가  
      (이전에 한번이라도 4.4.4.2와 통신이 되었다면 AA는 라우팅 테이블에 학습이 되어 4.4.4.2(4.4.4.0 대역대)로 가기 위해선 L3 #1에서 L3 #2 즉, 3.3.3.2로 나가야 한다는 것이 학습이 되어 있을 것)  
     2-1)인 경우에는 3.3.3.2로, 2-2)인 경우에는 기본 게이트웨이인 1.1.1.1으로 다음 경로를 지정할 것
  3. 위 과정에서 다음으로 갈 IP(게이트웨이 주소)는 알아냈지만, IP주소는 라우팅을 하기위한 수단일 뿐, 실질적으로 네트워크 장비간의 통신은 MAC주소로 하기 때문에 해당 게이트웨이 주소에 맞는 MAC주소를 알아야 함 그렇기에 2가지로 나뉨  
      3-1) 해당 IP주소에 대한 MAC 주소를 아는가  
      3-2) 해당 IP주소에 대한 MAC 주소를 모르는가  
     여기서 ARP 테이블을 통해 IP와 맞는 MAC 주소를 찾는데 3-1)인 경우가 ARP 테이블에 기록이 되어 있는 경우로, 이 경우에는 해당 장비로 이동이 되며, 3-2)인 경우 여기서 바로 **_ARP_** 가 동작이 된다. 위에서 설명한 ARP 패킷 주고받는 과정을 통하여 IP에 맞는 MAC주소를 알아내고 나서야 해당 장비로 이동이 된다.
  4. 2-1)인 경우에는 L3 #2의 라우터에서, 2-2)인 경우에는 L3 #1 라우터에서 위 1~3 과정 즉, Routing Table Lookup -> ARP Cache Lookup -> Forwarding 을 반복하여서 목적지에 도달하게 되는 것이다.

  </br>

  위에서는 복잡하게 설명하여 AA가 DD와 처음 통신한다는 가정하에 요약 설명하면

  1. AA는 Routing Table 확인 후 없는걸 보고 1.1.1.1 로 보내기로 정함
  2. 1.1.1.1에 대한 MAC주소를 알아내기 위해 ARP 테이블 확인
  3. 보통 기본 게이트웨이 주소는 ARP 테이블에 등록이 되어있지만 없을 경우에는 ARP 통신을 통해 MAC주소를 알아오고 L3 #1으로 이동
  4. L3 #1 또한 자신의 Routing Table 확인 하는데 위 그림에서는 이미 4.4.4.0 대역대는 3.3.3.2로 나가도록 구축이 되어 있기 때문에 3.3.3.2로 라우팅을 함
  5. 3.3.3.2 즉 L3 #2 라우터는 목적지가 4.4.4.2인걸 확인 후 자신의 Routing Table을 확인하여 어디로 보낼지 경로를 지정
  6. 4.4.4.2가 자신과 연결되어 있다는 걸 알고 있기 때문에 다음으로 MAC주소를 알아내기 위해 ARP 테이블 확인
  7. 이후 해당 MAC 주소를 통해 4.4.4.2(DD)에 도달

</br>

---

# **_참고_**

- https://run-it.tistory.com/16?category=665122 [ARP에 대하여]
- https://run-it.tistory.com/17?category=665122 [라우팅에 대하여]
- https://run-it.tistory.com/18?category=665122 [네트워크 통신과정]
- https://aahc.tistory.com/9 [ARP 및 라우팅 동작과정]
- https://jamong1014.tistory.com/42 [동일 서브넷에서의 동작과정]
